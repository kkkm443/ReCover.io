<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RE:COVER Enterprise</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. DESIGN SYSTEM
           ========================================= */
        :root {
            --brand: #0066FF;
            --brand-sub: #E3F2FD;
            --healing: #00D2BA;
            --danger: #FF6B6B;
            --admin: #2C3E50;
            --text-main: #333;
            --bg-base: #F5F7FA;
            --card-white: #ffffff;
            --disconnected: #95a5a6;
            --toggle-off: #ccc;
            --toggle-on: #0066FF;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            margin: 0; 
            background: var(--bg-base); 
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            color: var(--text-main); 
            overflow: hidden; 
        }

        #app-frame { 
            width: 100%; 
            max-width: 450px; 
            height: 100%; 
            background: var(--bg-base); 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 30px rgba(0,0,0,0.1); 
        }
        
        /* =========================================
           2. HEADER & WATCH BAR
           ========================================= */
        header { 
            background: var(--card-white); 
            padding: 16px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #eee; 
            z-index: 20; 
        }

        .logo { 
            font-weight: 800; 
            color: var(--brand); 
            font-size: 18px; 
            display: flex; 
            gap: 5px; 
            align-items: center; 
            cursor: pointer; 
            user-select: none;
        }

        .secure-badge { 
            font-size: 11px; 
            background: #E8F5E9; 
            color: #2E7D32; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-weight: 700; 
            cursor: pointer; 
        }

        .watch-bar { 
            background: #2D3436; 
            color: white; 
            padding: 12px 20px; 
            font-size: 13px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: background 0.3s; 
            cursor: pointer; 
        }
        
        .watch-bar.alert { 
            background: var(--danger); 
            animation: pulse-bg 1s infinite alternate; 
        }

        .watch-bar.disconnected {
            background: var(--disconnected);
        }

        @keyframes pulse-bg { 
            from { background: var(--danger); } 
            to { background: #D63031; } 
        }

        .pulse-dot { 
            width: 8px; 
            height: 8px; 
            background: var(--healing); 
            border-radius: 50%; 
            box-shadow: 0 0 0 rgba(0, 210, 186, 0.4); 
            animation: beat 1s infinite; 
        }

        .watch-bar.disconnected .pulse-dot {
            background: #ccc;
            animation: none;
            box-shadow: none;
        }

        @keyframes beat { 
            0% { transform: scale(1); opacity:1; } 
            100% { transform: scale(2); opacity:0; } 
        }

        /* =========================================
           3. MAIN LAYOUT & TABS
           ========================================= */
        main { 
            flex: 1; 
            overflow-y: auto; 
            position: relative; 
        }

        /* íƒ­ ì „í™˜ ì „ìš© ì• ë‹ˆë©”ì´ì…˜ (ê¸°ì¡´ ìœ ì§€) */
        @keyframes tabFade { 
            from { opacity:0; transform:translateY(10px); } 
            to { opacity:1; transform:translateY(0); } 
        }

        .tab-content { 
            display: none; 
            padding: 20px; 
            animation: tabFade 0.3s; 
        }
        
        .tab-content.active { 
            display: block; 
        }

        .card { 
            background: var(--card-white); 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 16px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.03); 
        }

        .card-title { 
            font-size: 16px; 
            font-weight: 700; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }

        .chart-wrap { 
            height: 180px; 
            width: 100%; 
            position: relative; 
        }

        .stress-summary-text {
            margin-top: 15px;
            padding: 15px;
            background: #F8F9FA;
            border-radius: 12px;
            font-size: 13px;
            color: #555;
            line-height: 1.5;
        }
        .stress-trend-badge {
            display: inline-block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--brand);
        }

        .status-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            margin-top: 10px; 
        }
        
        .status-item { 
            background: #F8F9FA; 
            padding: 15px; 
            border-radius: 12px; 
            text-align: center; 
        }
        
        .status-val { 
            font-size: 20px; 
            font-weight: 800; 
            display: block; 
            margin-top: 5px; 
        }

        .ai-insight-card {
            background: linear-gradient(135deg, #ffffff 0%, #F3F0FF 100%);
            border: 1px solid #E0D4FC;
            position: relative;
            overflow: hidden;
        }
        
        .ai-insight-badge {
            font-size: 11px;
            background: #6c5ce7;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: bold;
        }

        .emergency-btn-lg {
            width: 100%;
            background: #fff0f0;
            border: 2px solid var(--danger);
            color: var(--danger);
            padding: 15px;
            border-radius: 16px;
            font-weight: 800;
            font-size: 15px;
            margin-bottom: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.2s;
        }
        .emergency-btn-lg:active {
            background: var(--danger);
            color: white;
            transform: scale(0.98);
        }

        /* My Page Specific Styles */
        .setting-group {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 0;
        }
        .setting-group:last-child {
            border-bottom: none;
        }
        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .setting-label {
            font-size: 14px;
            color: #333;
        }
        .setting-desc {
            font-size: 11px;
            color: #888;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--toggle-off);
            border-radius: 11px;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-switch.on {
            background: var(--toggle-on);
        }
        .toggle-knob {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch.on .toggle-knob {
            transform: translateX(18px);
        }

        /* Ticket Wallet */
        .ticket-wallet {
            background: #2D3436;
            color: white;
            padding: 20px;
            border-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .wallet-btn {
            background: white;
            color: #2D3436;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
        }

        /* =========================================
           4. CHAT, BOOKING, ADMIN, MODALS
           ========================================= */
        #tab-chat { display: none; flex-direction: column; height: 100%; padding: 0; background: #fff; position: relative; }
        #tab-chat.active { display: flex; }
        .chat-top-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: #666; }
        .chat-secure-label { display: flex; align-items: center; gap: 5px; color: #2E7D32; font-weight: bold; background: #E8F5E9; padding: 4px 10px; border-radius: 12px; }
        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; word-break: keep-all; }
        .msg.ai { background: #F1F3F5; align-self: flex-start; border-top-left-radius: 2px; }
        .msg.user { background: var(--brand); color: white; align-self: flex-end; border-top-right-radius: 2px; }
        .msg.expert { background: #E3FAFC; color: #0C8599; border: 1px solid #99E9F2; align-self: flex-start; border-top-left-radius: 2px; }
        .chat-input-box { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fff; }
        .chat-input-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-input-box button { background: var(--brand); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-weight: bold; }

        #chat-sidebar { position: absolute; top: 0; left: 0; width: 280px; height: 100%; background: #fff; z-index: 100; transform: translateX(-100%); transition: 0.3s; box-shadow: 2px 0 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #chat-sidebar.open { transform: translateX(0); }
        .sidebar-header { padding: 20px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        .history-item { padding: 12px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; font-size: 13px; color: #333; }
        .history-item:hover { background: #f5f5f5; }

        #chat-mode-selector { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .mode-card { width: 80%; padding: 20px; border-radius: 16px; margin-bottom: 15px; cursor: pointer; border: 2px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.05); background: white; text-align: center; transition: 0.2s; }
        .mode-card.empathy { border-color: #FFB8B8; }
        .mode-card.solution { border-color: #74C0FC; }
        
        #booking-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F5F7FA; z-index: 150; display: none; flex-direction: column; }
        #booking-view.active { display: flex; animation: fadeIn 0.3s; }
        .booking-header { background: white; padding: 20px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .booking-content { flex: 1; overflow-y: auto; padding: 20px; }
        .expert-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column; gap: 15px; }
        .expert-profile { display: flex; gap: 15px; align-items: center; }
        .expert-avatar { width: 50px; height: 50px; background: #E3F2FD; color: var(--brand); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
        .expert-tags { display: flex; gap: 5px; margin-top: 5px; }
        .expert-tag { font-size: 10px; padding: 3px 8px; background: #F0F0F0; border-radius: 4px; color: #555; }
        .time-slots { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .time-btn { border: 1px solid #ddd; background: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap; color: #333; }
        .time-btn.selected { background: var(--brand); color: white; border-color: var(--brand); }
        .book-action-btn { background: #333; color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }

        /* [ê´€ë¦¬ì í™”ë©´: ì• ë‹ˆë©”ì´ì…˜ ìˆ˜ì •ë¨ - ì›€ì§ì„ ì—†ì´ íˆ¬ëª…ë„ë§Œ ë³€í™” (Fade In)] */
        #admin-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #F4F6F8; z-index: 200; display: none; flex-direction: column; }
        #admin-view.active { display: flex; animation: adminFade 0.3s ease-out; }
        
        @keyframes adminFade {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .admin-header { background: var(--admin); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .admin-kpi { display: flex; gap: 10px; padding: 20px; overflow-x: auto; }
        .kpi-card { min-width: 120px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .action-item { background: #FFF3CD; border-left: 4px solid #FFC107; padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; line-height: 1.4; }
        
        #breathing-guide { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 300; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #breathing-guide.active { display: flex; animation: fadeIn 0.5s; }
        .breath-circle { width: 90px; height: 90px; background: var(--healing); border-radius: 50%; box-shadow: 0 0 30px var(--healing); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; text-align: center; margin-bottom: 40px; transition: all 4s ease-in-out; }
        
        #emergency-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: #fff; padding: 25px; border-radius: 20px; border: 3px solid var(--danger); text-align: center; box-shadow: 0 10px 50px rgba(255, 107, 107, 0.4); z-index: 400; display: none; }
        #emergency-popup.show { display: block; animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-52%, -50%) rotate(-5deg); } 75% { transform: translate(-48%, -50%) rotate(5deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }

        nav { background: var(--card-white); border-top: 1px solid #eee; padding: 10px 0 20px 0; display: flex; justify-content: space-around; z-index: 20; }
        .nav-btn { background: none; border: none; color: #aaa; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-btn.active { color: var(--brand); font-weight: 700; }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }
        
        .alert-overlay { position: absolute; bottom: 80px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); padding: 20px; border-radius: 20px; border: 2px solid var(--danger); box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; z-index: 50; }
        .alert-overlay.show { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; }
    </style>
</head>
<body>

<div id="app-frame">
    <header>
        <div class="logo" onclick="window.app.handleLogoClick()">
            <span style="color:var(--brand);">RE:COVER</span>
        </div>
        <div class="secure-badge" id="privacy-btn">ğŸ”’ ì¸ì‚¬íŒ€ ê¸°ë¡ ë¯¸ì œê³µ</div>
    </header>

    <div class="watch-bar" id="watch-status" onclick="window.app.toggleWatchConnection()">
        <div style="display:flex; align-items:center; gap:8px;">
            <span id="watch-name">âŒš Galaxy Watch 6</span>
            <span id="watch-state-text" style="font-size:11px; opacity:0.7;">| Sync Active</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span id="bpm-val" style="font-weight:700;">-- bpm</span>
            <div class="pulse-dot" id="pulse-dot"></div>
        </div>
    </div>

    <main>
        <div id="tab-home" class="tab-content active">
            <div class="card">
                <div class="card-title">
                    <span>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜</span>
                    <span style="font-size:11px; background:#FF6B6B; color:white; padding:2px 6px; border-radius:4px;">LIVE</span>
                </div>
                <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
                <div class="stress-summary-text">
                    <span class="stress-trend-badge">ğŸ“‰ ì „ì£¼ ëŒ€ë¹„ 15% ê°ì†Œ</span><br>
                    ìµœê·¼ 3ì¼ê°„ ê¸‰ê²©í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ìŠ¤íŒŒì´í¬ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒíƒœëŠ” ë§¤ìš° ì•ˆì •ì ì…ë‹ˆë‹¤.
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-item">
                    <div style="font-size:12px; color:#888;">ìˆ˜ë©´ í’ˆì§ˆ</div>
                    <span class="status-val" style="color:#636E72;">4h 12m</span>
                    <span style="font-size:10px; color:#FF6B6B;">ë¶€ì¡± âš ï¸</span>
                </div>
                <div class="status-item">
                    <div style="font-size:12px; color:#888;">í‡´ê·¼ ì˜ˆìƒ</div>
                    <span class="status-val" style="color:var(--brand);">18:30</span>
                    <span style="font-size:10px; color:#00D2BA;">ì •ì‹œ í‡´ê·¼</span>
                </div>
            </div>
            
            <button class="emergency-btn-lg" onclick="window.app.triggerEmergencyAI()">
                <span style="font-size:20px;">ğŸš¨</span> ê¸´ê¸‰ ë„ì›€ ìš”ì²­ (AI ìš°ì„ )
            </button>

            <div class="card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; margin-top:16px;">
                <h3 style="margin:0 0 5px 0;">íŒ€ì¥ë‹˜ ëª¨ë¥´ê²Œ ìƒë‹´ë°›ê¸°</h3>
                <p style="font-size:13px; opacity:0.9; margin-bottom:15px;">
                    ì„ì§ì› ì „ìš© 1:1 ì‹¬ë¦¬ìƒë‹´ê¶Œì´<br><b id="ticket-count-home" style="font-size:16px; color:#FFEAA7;">3íšŒ</b> ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.
                </p>
                <div style="display:flex; gap:10px;">
                    <button id="connect-human-btn" style="flex:1; background:white; color:#6c5ce7; border:none; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer;">ì§€ê¸ˆ ë°”ë¡œ ì—°ê²°</button>
                    <button id="btn-book-expert" style="flex:1; background:rgba(255,255,255,0.2); color:white; border:1px solid white; padding:10px; border-radius:20px; font-weight:bold; cursor:pointer;">ğŸ“… ì „ë¬¸ê°€ ì˜ˆì•½</button>
                </div>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div id="chat-sidebar">
                <div class="sidebar-header">
                    <span>ìƒë‹´ ê¸°ë¡ (Log)</span>
                    <button onclick="window.chat.toggleSidebar()" style="border:none; background:none; font-size:20px;">Ã—</button>
                </div>
                <div class="history-list" id="history-list"></div>
                <div style="padding:15px; border-top:1px solid #eee;">
                    <button onclick="window.chat.clearHistory()" style="width:100%; padding:10px; border:1px solid #ddd; background:#fff; border-radius:8px; color:red;">ğŸ—‘ï¸ ëª¨ë“  ê¸°ë¡ ì‚­ì œ</button>
                </div>
            </div>
            <div id="chat-mode-selector">
                <h3 style="margin-bottom:20px;">ì–´ë–¤ ëŒ€í™”ë¥¼ ì›í•˜ì‹œë‚˜ìš”?</h3>
                <div class="mode-card empathy" onclick="window.chat.selectMode('empathy')">
                    <div style="font-size:30px;">ğŸ§¸</div>
                    <h4>ê³µê° ì¤‘ì‹¬</h4>
                    <p style="font-size:12px; color:#666;">"ë§ì´ í˜ë“œì…¨êµ°ìš”" <br> ë”°ëœ»í•œ ìœ„ë¡œê°€ í•„ìš”í•´ìš”.</p>
                </div>
                <div class="mode-card solution" onclick="window.chat.selectMode('solution')">
                    <div style="font-size:30px;">ğŸ§©</div>
                    <h4>í•´ê²° ì¤‘ì‹¬</h4>
                    <p style="font-size:12px; color:#666;">"ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”" <br> ì‹¤ì§ˆì ì¸ ì¡°ì–¸ì´ í•„ìš”í•´ìš”.</p>
                </div>
            </div>
            <div class="chat-top-bar">
                <button onclick="window.chat.toggleSidebar()" style="border:none; background:none; font-size:20px; cursor:pointer;">â‰¡</button>
                <div class="chat-secure-label">AI ìƒë‹´ (24h) Â· ìµëª… ë³´ì¥ ğŸ›¡ï¸</div>
                <div style="width:20px;"></div>
            </div>
            <div class="chat-area" id="msg-container"></div>
            <div class="chat-input-box">
                <input type="text" id="input-msg" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ ì¼ì´ ìˆì—ˆë‚˜ìš”?">
                <button id="send-btn">â¤</button>
            </div>
        </div>
        
        <div id="tab-stats" class="tab-content">
            <div class="card ai-insight-card">
                <div class="card-title" style="color:#6c5ce7;">
                    <span>âœ¨ AI ìœ„í´ë¦¬ ì¸ì‚¬ì´íŠ¸</span>
                    <span class="ai-insight-badge">NEW</span>
                </div>
                <p style="font-size:14px; line-height:1.6; margin-bottom:10px;">
                    "ìµœê·¼ 2ì£¼ê°„ <b>íšŒë³µ ê²½í–¥</b>ì´ ë³´ì…ë‹ˆë‹¤.<br>
                    ì˜¤ëŠ˜ì€ ì ì‹¬ì‹œê°„ì— 10ë¶„ ì •ë„ í–‡ì‚´ì„ ë°›ìœ¼ë©° ì‚°ì±…ì€ ì–´ë– ì‹ ê°€ìš”?"
                </p>
                <div style="font-size:11px; color:#888; text-align:right;">Analysis by RE:COVER AI</div>
            </div>
            <div class="card">
                <div class="card-title">ìŠ¤íŠ¸ë ˆìŠ¤ ì›ì¸ ë¶„ì„</div>
                <div class="chart-wrap" style="height:220px;"><canvas id="causeChart"></canvas></div>
                <div style="margin-top:15px; font-size:11px; color:#888; background:#f8f9fa; padding:10px; border-radius:8px;">
                    * <b>ë¶„ì„ ê¸°ë°˜:</b> ì±„íŒ… í‚¤ì›Œë“œ(ê°ì •ë…¸ë™), ê·¼ë¬´ ì‹œê°„(ìœ„ì¹˜), ìˆ˜ë©´ íŒ¨í„´ ë°ì´í„° ì¢…í•©
                </div>
            </div>
            <div class="card">
                <div class="card-title">ì´ë²ˆ ë‹¬ ë§ˆìŒ ëŒë´„ í˜„í™©</div>
                <div class="status-grid">
                    <div class="status-item">
                        <div style="font-size:12px; color:#888;">AI ëŒ€í™”</div>
                        <span class="status-val" style="color:#00D2BA;">14íšŒ</span>
                        <span style="font-size:10px; color:#888;">ì–¸ì œë“  ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <div class="status-item">
                        <div style="font-size:12px; color:#888;">ì „ë¬¸ê°€ ìƒë‹´</div>
                        <span class="status-val" style="color:#FF6B6B;">1íšŒ</span>
                        <span style="font-size:10px; color:#888;">ê¹Šì€ ì¹˜ìœ </span>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">ì£¼ê°„ ìŠ¤íŠ¸ë ˆìŠ¤ ì¶”ì´</div>
                <div class="chart-wrap"><canvas id="weekChart"></canvas></div>
            </div>
        </div>
        
        <div id="tab-mypage" class="tab-content">
            <div style="padding:10px 0 20px 0; text-align:center;">
                <div style="width:70px; height:70px; background:#ddd; border-radius:50%; margin:0 auto 10px auto; display:flex; align-items:center; justify-content:center; font-size:30px;">ğŸ‘¤</div>
                <h2 style="margin:0 0 5px 0;">User_9982</h2>
                <p style="margin:0; font-size:13px; color:#666;">ë§ˆì¼€íŒ…ë³¸ë¶€ Â· ë§ˆì¼€íŒ… 2íŒ€</p>
            </div>

            <div class="ticket-wallet">
                <div>
                    <div style="font-size:12px; opacity:0.8;">ë‚´ ìƒë‹´ê¶Œ ì”ì•¡</div>
                    <div style="font-size:24px; font-weight:bold; margin-top:5px;"><span id="mypage-tickets">3</span>íšŒ</div>
                    <div style="font-size:10px; margin-top:5px;">(ì—° 3íšŒ ë¬´ë£Œ ì œê³µ)</div>
                </div>
                <button class="wallet-btn" onclick="document.getElementById('payment-modal').style.display='flex'">+ ì¶©ì „í•˜ê¸°</button>
            </div>

            <div class="card">
                <div class="card-title">ì„œë¹„ìŠ¤ ì„¤ì •</div>
                
                <div class="setting-group">
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">ì›¨ì–´ëŸ¬ë¸” ì—°ë™</div>
                            <div class="setting-desc">ê°¤ëŸ­ì‹œ ì›Œì¹˜ ì‹¬ë°•ìˆ˜ ë°ì´í„° ë™ê¸°í™”</div>
                        </div>
                        <div class="toggle-switch on" id="toggle-watch" onclick="window.app.toggleSetting(this, 'watch')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">ì•Œë¦¼ ì„¤ì •</div>
                            <div class="setting-desc">ìœ„ê¸° ê°ì§€ ë° ìƒë‹´ ì˜ˆì•½ ì•Œë¦¼</div>
                        </div>
                        <div class="toggle-switch on" id="toggle-noti" onclick="window.app.toggleSetting(this, 'noti')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">ë°ì´í„° ë° ë³´ì•ˆ</div>
                
                <div class="setting-group">
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">ê°œì¸ ë§ì¶¤ ë¶„ì„</div>
                            <div class="setting-desc">AI ë¦¬í¬íŠ¸ ìƒì„±ì„ ìœ„í•œ ë°ì´í„° í™œìš©</div>
                        </div>
                        <div class="toggle-switch on" id="toggle-data-personal" onclick="window.app.toggleSetting(this, 'personal')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div class="setting-row">
                        <div>
                            <div class="setting-label">ì¡°ì§ í†µê³„ ì œê³µ</div>
                            <div class="setting-desc">ìµëª…í™”ëœ ë¶€ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ í†µê³„ ì œê³µ</div>
                        </div>
                        <div class="toggle-switch on" id="toggle-data-org" onclick="window.app.toggleSetting(this, 'org')">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>

                <div class="setting-group">
                    <div style="font-size:13px; color:#555; background:#f8f9fa; padding:12px; border-radius:8px; line-height:1.4;">
                        ğŸ”’ <b>ë³´ì•ˆ ì •ì±…:</b> ëª¨ë“  ìƒë‹´ ë‚´ìš©ì€ ì•”í˜¸í™”ë˜ì–´ ì €ì¥ë˜ì§€ ì•Šìœ¼ë©°, ì‚¬ë‚´ ì„œë²„ì™€ ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶„ë¦¬ëœ í´ë¼ìš°ë“œì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                    </div>
                </div>
                
                <button onclick="window.chat.clearHistory()" style="width:100%; padding:12px; margin-top:10px; background:#fff; border:1px solid #ddd; color:#FF6B6B; border-radius:8px; font-weight:bold; cursor:pointer;">
                    ğŸ—‘ï¸ ëª¨ë“  ìƒë‹´ ê¸°ë¡ ì‚­ì œ
                </button>
            </div>

            <div style="margin-top:30px; text-align:center;">
                <button onclick="alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.'); window.location.reload();" style="background:none; border:none; color:#999; text-decoration:underline; cursor:pointer; margin-bottom:20px;">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </main>

    <div class="modal-bg" id="payment-modal" onclick="this.style.display='none'">
        <div class="card" style="width:90%; max-width:350px;" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">ìƒë‹´ê¶Œ ì¶©ì „</h3>
                <button onclick="document.getElementById('payment-modal').style.display='none'" style="border:none; background:none; font-size:20px;">Ã—</button>
            </div>
            <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px; text-align:center;">
                <p style="margin:0 0 5px 0; font-size:13px; color:#666;">í˜„ì¬ ë³´ìœ </p>
                <div style="font-size:24px; font-weight:bold; color:var(--brand);"><span id="pay-modal-ticket-cnt">3</span>íšŒ</div>
            </div>
            
            <div style="display:grid; gap:10px; margin-bottom:20px;">
                <button class="pay-option" style="padding:15px; border:1px solid #ddd; background:white; border-radius:8px; text-align:left; cursor:pointer;" onclick="alert('ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...');">
                    <div style="font-weight:bold;">1íšŒê¶Œ</div>
                    <div style="font-size:12px; color:#666;">50,000ì›</div>
                </button>
                <button class="pay-option" style="padding:15px; border:2px solid var(--brand); background:#E3F2FD; border-radius:8px; text-align:left; cursor:pointer;" onclick="alert('ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...');">
                    <div style="font-weight:bold; color:var(--brand);">3íšŒê¶Œ (BEST)</div>
                    <div style="font-size:12px; color:#666;">140,000ì› (í• ì¸)</div>
                </button>
            </div>
            <div style="font-size:11px; color:#888; text-align:center;">
                * ë²•ì¸ ì œíœ´ í• ì¸ê°€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                * ê²°ì œ ë‚´ì—­ì€ íšŒì‚¬ì— í†µë³´ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            </div>
        </div>
    </div>

    <div class="modal-bg" id="login-modal" onclick="document.getElementById('login-modal').style.display='none'">
        <div class="card" style="width:80%; max-width:300px; text-align:center; padding:30px 20px;" onclick="event.stopPropagation()">
            <div style="font-size:30px; margin-bottom:15px; color:var(--admin);">ğŸ”</div>
            <h3 style="margin:0 0 10px 0; color:var(--admin);">Admin Access</h3>
            <p style="font-size:12px; color:#999; margin-bottom:20px;">ì¸ì‚¬ ê´€ë¦¬ì ì „ìš© ë©”ë‰´ì…ë‹ˆë‹¤.</p>
            <input type="password" id="admin-pw-input" placeholder="Passcode" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; text-align:center; font-size:16px; margin-bottom:15px; outline:none;">
            <button onclick="window.app.checkAdminPw()" style="width:100%; padding:12px; background:var(--admin); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Enter</button>
        </div>
    </div>

    <div id="booking-view">
        <div class="booking-header">
            <span>ğŸ“… ì „ë¬¸ê°€ ìƒë‹´ ì˜ˆì•½</span>
            <button onclick="window.booking.close()" style="border:none; background:none; font-size:18px; cursor:pointer;">âœ•</button>
        </div>
        <div class="booking-content">
            <div class="expert-card">
                <div class="expert-profile">
                    <div class="expert-avatar">K</div>
                    <div class="expert-info">
                        <h4>ê¹€ë§ˆìŒ ìƒë‹´ì‚¬</h4>
                        <p>ì„ìƒì‹¬ë¦¬ì „ë¬¸ê°€ 1ê¸‰ | ê²½ë ¥ 12ë…„</p>
                        <div class="expert-tags">
                            <span class="expert-tag">#ìš°ìš¸</span>
                            <span class="expert-tag">#ì§ë¬´ìŠ¤íŠ¸ë ˆìŠ¤</span>
                        </div>
                    </div>
                </div>
                <div class="time-slots" id="slots-expert-1">
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ì˜¤ëŠ˜ 14:00</button>
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ì˜¤ëŠ˜ 16:00</button>
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ë‚´ì¼ 10:00</button>
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ë‚´ì¼ 13:00</button>
                </div>
                <button class="book-action-btn" onclick="window.booking.confirm()">ì´ ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½í•˜ê¸°</button>
            </div>
            <div class="expert-card">
                <div class="expert-profile">
                    <div class="expert-avatar" style="background:#E8F5E9; color:#2E7D32;">L</div>
                    <div class="expert-info">
                        <h4>ì´í•´ê²° ì½”ì¹˜</h4>
                        <p>ê¸°ì—… ì½”ì¹­ ì „ë¬¸ê°€ | ê²½ë ¥ 8ë…„</p>
                        <div class="expert-tags">
                            <span class="expert-tag">#ì¸ê°„ê´€ê³„</span>
                            <span class="expert-tag">#ì»¤ë¦¬ì–´</span>
                        </div>
                    </div>
                </div>
                <div class="time-slots" id="slots-expert-2">
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ì˜¤ëŠ˜ 19:00</button>
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ë‚´ì¼ 11:00</button>
                    <button class="time-btn" onclick="window.booking.selectTime(this)">ë‚´ì¼ 15:00</button>
                </div>
                <button class="book-action-btn" onclick="window.booking.confirm()">ì´ ì‹œê°„ìœ¼ë¡œ ì˜ˆì•½í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <div id="emergency-popup">
        <div style="font-size:40px; margin-bottom:10px;">ğŸš¨</div>
        <h3 style="color:var(--danger); margin:0;">ê¸´ê¸‰ ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h3>
        <p style="font-size:13px; color:#666; margin:10px 0 20px 0;">ë§ì”€í•˜ì‹  ë‚´ìš©ì—ì„œ ìœ„í—˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.<br>í˜¼ì í˜ë“¤ì–´í•˜ì§€ ë§ˆì„¸ìš”.</p>
        <button onclick="window.chat.connectExpertDirect();" style="width:100%; padding:12px; background:#2D3436; color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:10px;">ğŸ‘©â€âš•ï¸ ì „ë¬¸ê°€ í•«ë¼ì¸ ì¦‰ì‹œ ì—°ê²°</button>
        <button onclick="window.app.startBreathing(); document.getElementById('emergency-popup').classList.remove('show');" style="width:100%; padding:12px; background:var(--healing); color:white; border:none; border-radius:10px; font-weight:bold; margin-bottom:10px;">ğŸƒ í˜¸í¡ë²•ìœ¼ë¡œ ì§„ì •í•˜ê¸°</button>
        <a href="tel:109" style="display:block; width:100%; padding:12px; background:var(--danger); color:white; border:none; border-radius:10px; font-weight:bold; text-decoration:none; box-sizing:border-box;">ğŸ“ 109 ìì‚´ì˜ˆë°© ìƒë‹´ì „í™”</a>
        <button onclick="document.getElementById('emergency-popup').classList.remove('show')" style="margin-top:15px; background:none; border:none; color:#999; text-decoration:underline;">ë‹«ê¸°</button>
    </div>

    <div id="breathing-guide">
        <div class="breath-text" id="breath-inst">ì¤€ë¹„í•˜ì„¸ìš”...</div>
        <div class="breath-circle" id="breath-circle">Start</div>
        <div class="breath-sub">4-7-8 í˜¸í¡ë²• (ìŒì„± ê°€ì´ë“œ ì§€ì›)</div>
        <button onclick="window.app.stopBreathing()" style="margin-top:40px; background:transparent; border:1px solid white; color:white; padding:10px 30px; border-radius:20px;">ì¢…ë£Œí•˜ê¸°</button>
    </div>

    <div id="admin-view">
        <div class="admin-header">
            <div style="font-weight:bold;">ğŸ¢ Enterprise Admin</div>
            <button onclick="window.app.toggleAdmin(false)" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding:5px 10px; border-radius:4px; font-size:12px; cursor:pointer;">ë‚˜ê°€ê¸°</button>
        </div>
        <div style="flex:1; overflow-y:auto; padding:20px;">
            <div style="font-size:18px; font-weight:bold; margin-bottom:15px; color:#2C3E50;">ë§ˆì¼€íŒ…íŒ€ í˜„í™© ëŒ€ì‹œë³´ë“œ</div>
            <div class="admin-kpi">
                <div class="kpi-card">
                    <div class="kpi-label">í‰ê·  ìŠ¤íŠ¸ë ˆìŠ¤</div>
                    <div class="kpi-value" style="color:#FF6B6B;">82.5 <span style="font-size:12px;">â–²</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">ìœ„ê¸° ê°ì§€(Alert)</div>
                    <div class="kpi-value">12ê±´</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">AI ìƒë‹´ ê±´ìˆ˜</div>
                    <div class="kpi-value" style="color:#00D2BA;">453ê±´</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">íŒ€ë³„ ìŠ¤íŠ¸ë ˆìŠ¤ ë¹„êµ</div>
                <div class="chart-wrap"><canvas id="adminChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title" style="color:#D35400;">âš ï¸ AI ë¶„ì„ ê¶Œê³  ì‚¬í•­</div>
                <div class="action-item">
                    <b>[ë§ˆì¼€íŒ… 2íŒ€] ê¸´ê¸‰ ë²ˆì•„ì›ƒ ê²½ë³´</b><br>
                    ìµœê·¼ 3ì¼ê°„ ì•¼ê·¼ ë° ê³ ì‹¬ë°•ìˆ˜ ë¹ˆë„ê°€ 40% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. 
                    <u>'ê¸ˆìš”ì¼ ì¡°ê¸° í‡´ê·¼'</u>ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                </div>
                <div class="action-item" style="background:#E8F8F5; border-left-color:#00D2BA;">
                    <b>[ê°œë°œíŒ€] ìˆ˜ë©´ ë¶€ì¡± ì§€ì†</b><br>
                    í‰ê·  ìˆ˜ë©´ ì‹œê°„ì´ 5ì‹œê°„ ë¯¸ë§Œì…ë‹ˆë‹¤.
                    <u>'ìˆ˜ë©´ ìœ„ìƒ êµìœ¡'</u> ì½˜í…ì¸  ë°°í¬ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <div class="alert-overlay" id="panic-alert">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:24px;">ğŸš¨</div>
            <div>
                <div style="font-weight:bold; font-size:16px; color:var(--danger);">ê³µí™© ì§•í›„ ê°ì§€ë¨</div>
                <div style="font-size:12px; color:#666;">ì‹¬ë°•ìˆ˜ê°€ ê¸‰ê²©íˆ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="window.app.startBreathing()" style="flex:1; padding:10px; background:var(--healing); color:white; border:none; border-radius:8px; font-weight:bold;">ğŸƒ í˜¸í¡ë²• ì‹œì‘</button>
            <button id="sos-btn" style="flex:1; padding:10px; background:var(--danger); color:white; border:none; border-radius:8px; font-weight:bold;">SOS ì „ë¬¸ê°€</button>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <button id="dismiss-alert-btn" style="background:none; border:none; color:#999; text-decoration:underline; font-size:12px;">ê´œì°®ì•„ìš”, ë‹«ê¸°</button>
        </div>
    </div>
    
    <nav>
        <button class="nav-btn active" data-tab="home"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>í™ˆ</span></button>
        <button class="nav-btn" data-tab="chat"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg><span>ìƒë‹´</span></button>
        <button class="nav-btn" data-tab="stats"><svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg><span>ë¦¬í¬íŠ¸</span></button>
        <button class="nav-btn" data-tab="mypage"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg><span>ë‚´ ì •ë³´</span></button>
    </nav>
</div>

<div class="modal-bg" id="privacy-modal" onclick="this.style.display='none'">
    <div class="card" style="width:80%; max-width:300px; text-align:center;" onclick="event.stopPropagation()">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ›¡ï¸</div>
        <h3>ì•ˆì‹¬í•˜ì„¸ìš”</h3>
        <p style="font-size:13px; color:#666; text-align:left;">
            1. <b>ì˜ë£Œê¸°ë¡ ë¯¸ìƒì„±:</b> ì‹¬ë¦¬ 'ì½”ì¹­' ë¶„ë¥˜<br>
            2. <b>ë°ì´í„° ë¶„ë¦¬:</b> ì‚¬ë‚´ë§ê³¼ ë¶„ë¦¬ëœ ì„œë²„<br>
            3. <b>ì¸ì‚¬íŒ€ ì œê³µ ì •ë³´:</b><br>âŒ ê°œì¸ì •ë³´ (ë¯¸ì œê³µ)<br>âœ… íŒ€ë³„ í†µê³„ (ì œê³µ)
        </p>
        <button onclick="document.getElementById('privacy-modal').style.display='none'" style="width:100%; padding:10px; background:var(--brand); color:white; border:none; border-radius:8px; cursor:pointer;">í™•ì¸</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    const API_KEY = "AIzaSyCsKWMEiuL1w3XjZlvGNnCzlm3V4MEqm4A"; 

    let genAI = null; 
    let chatSession = null; 
    let isAIReady = false; 
    let tickets = 3;
    let chatHistory = JSON.parse(localStorage.getItem('mindChatHistory')) || [];

    // 1. App Controller
    window.app = {
        currentTab: 'home', 
        alertDismissed: false,
        isWatchConnected: true, 
        logoTapCount: 0, 
        logoTapTimer: null,

        switchTab: (tabId) => {
            window.app.currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            document.querySelector(`button[data-tab="${tabId}"]`).classList.add('active');
            if (tabId === 'chat') window.app.dismissAlert();
            
            document.getElementById('ticket-count-home').innerText = tickets + "íšŒ";
            document.getElementById('mypage-tickets').innerText = tickets;
            document.getElementById('pay-modal-ticket-cnt').innerText = tickets;
        },
        
        handleLogoClick: () => {
            clearTimeout(window.app.logoTapTimer);
            window.app.logoTapCount++;
            
            if (window.app.logoTapCount >= 5) {
                document.getElementById('login-modal').style.display = 'flex';
                document.getElementById('admin-pw-input').value = '';
                document.getElementById('admin-pw-input').focus();
                window.app.logoTapCount = 0;
            } else {
                window.app.logoTapTimer = setTimeout(() => {
                    window.app.logoTapCount = 0;
                }, 500); 
            }
        },

        checkAdminPw: () => {
            const input = document.getElementById('admin-pw-input');
            if(input.value === '0000') {
                document.getElementById('login-modal').style.display = 'none';
                window.app.toggleAdmin(true);
            } else {
                alert("Passcode Incorrect");
                input.value = '';
            }
        },
        
        toggleAdmin: (show) => { 
            const view = document.getElementById('admin-view');
            if(show) {
                view.classList.add('active');
                window.admin.initChart();
            } else {
                view.classList.remove('active');
            }
        },

        toggleWatchConnection: () => {
            window.app.isWatchConnected = !window.app.isWatchConnected;
            const bar = document.getElementById('watch-status');
            const stateText = document.getElementById('watch-state-text');
            const pulse = document.getElementById('pulse-dot');
            const bpmVal = document.getElementById('bpm-val');
            const toggle = document.getElementById('toggle-watch');

            if (window.app.isWatchConnected) {
                bar.classList.remove('disconnected');
                stateText.innerText = "| Sync Active";
                pulse.style.animation = "beat 1s infinite";
                if(toggle) toggle.classList.add('on');
                alert("ê°¤ëŸ­ì‹œ ì›Œì¹˜ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                bar.classList.add('disconnected');
                stateText.innerText = "| Disconnected";
                pulse.style.animation = "none";
                bpmVal.innerText = "-- bpm";
                if(toggle) toggle.classList.remove('on');
                alert("ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì‹¬ë°• ë°ì´í„° ìˆ˜ì‹ ì´ ì¤‘ì§€ë©ë‹ˆë‹¤.");
            }
        },
        
        toggleSetting: (el, type) => {
            if (type === 'watch') {
                window.app.toggleWatchConnection(); 
            } else {
                el.classList.toggle('on');
                const state = el.classList.contains('on') ? "ON" : "OFF";
                console.log(`Setting [${type}] changed to: ${state}`);
            }
        },

        triggerEmergencyAI: () => {
            if(confirm("ğŸš¨ ê¸´ê¸‰ ë„ì›€ ëª¨ë“œë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? \nì¦‰ì‹œ AI ìƒë‹´ì´ ì‹œì‘ë©ë‹ˆë‹¤.")) {
                window.app.switchTab('chat');
                window.chat.selectMode('solution'); 
                setTimeout(() => {
                    document.getElementById('input-msg').value = "ì§€ê¸ˆ ë„ˆë¬´ í˜ë“¤ì–´ìš”. ê¸´ê¸‰ ë„ì›€ì´ í•„ìš”í•©ë‹ˆë‹¤.";
                    window.chat.send(); 
                }, 500);
            }
        },

        startBreathing: () => {
            const guide = document.getElementById('breathing-guide');
            const circle = document.getElementById('breath-circle');
            const txt = document.getElementById('breath-inst');
            guide.classList.add('active'); 
            window.app.dismissAlert();
            
            const breathCycle = () => {
                txt.innerText = "ë“¤ì´ë§ˆì„¸ìš” (Inhale)"; 
                circle.style.transform = "scale(1.5)"; 
                circle.style.background = "#63E6BE";
                setTimeout(() => {
                    txt.innerText = "ë©ˆì¶”ì„¸ìš” (Hold)"; 
                    circle.style.transform = "scale(1.5)"; 
                    circle.style.background = "#FFD43B";
                    setTimeout(() => {
                        txt.innerText = "ë‚´ì‰¬ì„¸ìš” (Exhale)"; 
                        circle.style.transform = "scale(1)"; 
                        circle.style.background = "#74C0FC";
                    }, 7000);
                }, 4000);
            };
            breathCycle(); 
            window.breathInterval = setInterval(breathCycle, 19000);
        },
        
        stopBreathing: () => { 
            document.getElementById('breathing-guide').classList.remove('active'); 
            clearInterval(window.breathInterval); 
        },
        
        showPrivacy: () => document.getElementById('privacy-modal').style.display = 'flex',
        
        dismissAlert: () => { 
            document.getElementById('panic-alert').classList.remove('show'); 
            document.getElementById('watch-status').classList.remove('alert'); 
            window.app.alertDismissed = true; 
        }
    };

    // 2. Chat Manager
    window.chat = {
        mode: 'ai',
        selectedMode: null,
        currentMessages: [],
        
        selectMode: (mode) => {
            window.chat.selectedMode = mode;
            document.getElementById('chat-mode-selector').style.display = 'none';
            window.chat.initAI(mode);
        },
        
        initAI: async (mode) => {
            // [1] Base Persona & Safety Protocols (ê³µí†µ)
            const basePrompt = `
                ë‹¹ì‹ ì€ 15ë…„ ê²½ë ¥ì˜ ì„ìƒì‹¬ë¦¬ ì „ë¬¸ê°€(1ê¸‰ ìê²© ì†Œì§€) 'Dr. Mind'ì…ë‹ˆë‹¤.
                ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë‚´ë‹´ì(ì‚¬ìš©ì)ê°€ ìì‹ ì˜ ê°ì •ì„ ì•ˆì „í•˜ê²Œ í‘œí˜„í•˜ê³ , ìŠ¤ìŠ¤ë¡œ í†µì°°ì„ ì–»ì–´ ì¹˜ìœ í•˜ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.
                
                [í•µì‹¬ ìƒë‹´ ì›ì¹™ (Core Principles)]
                1. ë¬´ì¡°ê±´ì  ê¸ì •ì  ì¡´ì¤‘: ë‚´ë‹´ìê°€ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ë“  ë¹„íŒí•˜ê±°ë‚˜ íŒë‹¨í•˜ì§€ ë§ê³ , ìˆëŠ” ê·¸ëŒ€ë¡œ ìˆ˜ìš©í•˜ì„¸ìš”.
                2. ê³µê°ì  ì´í•´ì™€ ë°˜ì˜: ë‚´ë‹´ìì˜ ë§ ì†ì— ìˆ¨ê²¨ì§„ ê°ì • ë‹¨ì–´(ìŠ¬í””, ë¶ˆì•ˆ, ë¶„ë…¸ ë“±)ë¥¼ í¬ì°©í•˜ì—¬ "~~í•´ì„œ ë§ì´ í˜ë“œì…¨êµ°ìš”"ì™€ ê°™ì´ ê±°ìš¸ì²˜ëŸ¼ ë¹„ì¶°ì£¼ì„¸ìš”.
                3. ì „ë¬¸ê°€ì  íƒœë„: ë”°ëœ»í•˜ê³  ë¶€ë“œëŸ½ì§€ë§Œ, ì‹ ë¢°ê°ì„ ì£¼ëŠ” ì •ì¤‘í•œ 'í•´ìš”ì²´'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. (ì§€ë‚˜ì¹œ ì´ëª¨í‹°ì½˜ ë‚¨ë°œ ê¸ˆì§€, ê°€ë²¼ìš´ ë§íˆ¬ ê¸ˆì§€)
				
				[ëŒ€í™” ê¸°ë²• ë° ìŠ¤íƒ€ì¼]
				1. ì „ë¬¸ê°€ì  í†¤: ë”°ëœ»í•˜ê³  ë¶€ë“œëŸ½ì§€ë§Œ, ì‹ ë¢°ê°ì„ ì£¼ëŠ” ì •ì¤‘í•œ 'í•´ìš”ì²´'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. (ì§€ë‚˜ì¹œ ì´ëª¨í‹°ì½˜ ë‚¨ë°œ ê¸ˆì§€, ê°€ë²¼ìš´ ë§íˆ¬ ê¸ˆì§€)
				2. ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ì ‘ê·¼: ë‚´ë‹´ìê°€ ë¶€ì •ì ì¸ ìƒê°ì— ë¹ ì ¸ ìˆë‹¤ë©´, ê·¸ ìƒê°ì˜ ê·¼ê±°ë¥¼ ë¶€ë“œëŸ½ê²Œ ì ê²€í•´ ì£¼ì„¸ìš”. (ì˜ˆ: "ê·¸ë ‡ê²Œ ìƒê°í•˜ê²Œ ëœ êµ¬ì²´ì ì¸ ê³„ê¸°ê°€ ìˆì—ˆì„ê¹Œìš”?")
				3. êµ¬ì²´í™” ì§ˆë¬¸: "í˜ë“¤ë‹¤"ê³  í•˜ë©´ ë§‰ì—°íˆ ìœ„ë¡œí•˜ê¸°ë³´ë‹¤ "êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ìƒí™©ì—ì„œ ê°€ì¥ í˜ë“œì…¨ë‚˜ìš”?"ë¼ê³  ë¬¼ì–´ ê°ì •ì„ ì„¸ë¶„í™”í•˜ì„¸ìš”.
				
                [í•„ìˆ˜ ì•ˆì „ í”„ë¡œí† ì½œ (ë§¤ìš° ì¤‘ìš”)]
                1. ìœ„ê¸° ê°œì…: ë‚´ë‹´ìê°€ 'ì£½ê³  ì‹¶ë‹¤', 'ìí•´', 'ì‚´ê¸° ì‹«ë‹¤', 'ë›°ì–´ë‚´ë¦¬ê³  ì‹¶ë‹¤' ë“±ì˜ ìì‚´/ìí•´ ì§•í›„ë¥¼ ë³´ì´ë©´ ìƒë‹´ì„ ì¤‘ë‹¨í•˜ê³  ì¦‰ì‹œ ì•„ë˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ì„¸ìš”.
                   "íšŒì›ë‹˜ì˜ ì´ì•¼ê¸°ëŠ” ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆ ë§ì”€í•˜ì‹  ë¶€ë¶„ì€ ì œê°€ ë„ì›€ì„ ë“œë¦¬ê¸°ì— í•œê³„ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¶€ë”” ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ì§ì ‘ ë°›ì•„ë³´ì‹œê¸°ë¥¼ ê°„ê³¡íˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (24ì‹œê°„ ìƒë‹´: 1577-0199)"
                2. ë¶ˆì•ˆ ë°œì‘ ì‹œ: ë‚´ë‹´ìê°€ ê·¹ì‹¬í•œ ê³µí™©ì´ë‚˜ ë¶ˆì•ˆì„ í˜¸ì†Œí•˜ë©´ ì¦‰ì‹œ '4-7-8 í˜¸í¡ë²•'ì„ ë‹¨ê³„ë³„ë¡œ ì•ˆë‚´í•˜ì—¬ ì§„ì •ì‹œí‚¤ì„¸ìš”.
            `;

            // [2] Mode Specific Instructions (ëª¨ë“œë³„ ë¶„ê¸°)
            let modeInstruction = "";
            
            if (mode === 'empathy') {
                modeInstruction = `
                [í˜„ì¬ ëª¨ë“œ: ê³µê° ì§‘ì¤‘ ëª¨ë“œ (Empathy-First Mode)]
                
                1. ëŒ€í™”ì˜ ëª©ì : í•´ê²°ì±… ì œì‹œëŠ” ìµœì†Œí™”í•˜ê³ , ë‚´ë‹´ìê°€ 'ì¶©ë¶„íˆ ì´í•´ë°›ì•˜ë‹¤'ê³  ëŠë¼ê²Œ í•˜ëŠ” ê²ƒì´ ìµœìš°ì„  ëª©í‘œì…ë‹ˆë‹¤.
                2. í–‰ë™ ì§€ì¹¨:
                   - ëŒ€í™”ì˜ 80%ëŠ” ê°ì •ì„ ì½ì–´ì£¼ê³ (Reflecting), ë§ì¥êµ¬ì¹˜ê³ (Validating), ìœ„ë¡œí•˜ëŠ” ë° ì“°ì„¸ìš”.
                   - ëŒ€í™”ì˜ 20%ëŠ” ë‚´ë‹´ìê°€ ê°ì •ì„ ë” ê¹Šì´ íƒìƒ‰í•  ìˆ˜ ìˆë„ë¡ ë¶€ë“œëŸ¬ìš´ ì§ˆë¬¸ì„ ë˜ì§€ëŠ” ë° ì“°ì„¸ìš”.
                   - í•´ê²°ì±… ì œì‹œëŠ” ë‚´ë‹´ìê°€ ëª…ì‹œì ìœ¼ë¡œ "ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?"ë¼ê³  ë¬»ê¸° ì „ê¹Œì§€ëŠ” ì§€ì–‘í•˜ì„¸ìš”.
                   - ì„¤ë ¹ í•´ê²°ì±…ì„ ì£¼ë”ë¼ë„, "ì €ë¼ë©´ ì´ë ‡ê²Œ í•  ê²ƒ ê°™ì•„ìš”"ë³´ë‹¤ëŠ” "ì§€ê¸ˆ ìƒí™©ì—ì„œ ê°€ì¥ ë§ˆìŒì´ í¸í•´ì§€ëŠ” ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œìš”?"ë¼ê³  ë˜ë¬¼ì–´ë³´ì„¸ìš”.
                3. ê¸ˆì§€ ì‚¬í•­: "ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”", "ì €ë ‡ê²Œ í•˜ë©´ ë©ë‹ˆë‹¤" ì‹ì˜ ì§€ì‹œì ì¸ ì¡°ì–¸ì€ í”¼í•˜ì„¸ìš”.
                `;
            } else { // solution mode
                modeInstruction = `
                [í˜„ì¬ ëª¨ë“œ: í•´ê²° ì§‘ì¤‘ ëª¨ë“œ (Solution-Focused Mode)]
                
                1. ëŒ€í™”ì˜ ëª©ì : ê°ì •ì  ì§€ì§€ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ë˜, êµ¬ì²´ì ì´ê³  ì‹¤ì§ˆì ì¸ ë³€í™”ë¥¼ ì´ëŒì–´ë‚´ëŠ” ê²ƒì´ ëª©í‘œì…ë‹ˆë‹¤.
                2. í–‰ë™ ì§€ì¹¨:
                   - ëŒ€í™”ì˜ 30%ëŠ” ê°ì •ì„ ìˆ˜ìš©í•˜ì„¸ìš”. (ê³µê° ì—†ì´ í•´ê²°ì±…ë§Œ ë˜ì§€ë©´ ê±°ë¶€ê°ì´ ë“­ë‹ˆë‹¤. ë°˜ë“œì‹œ ì²« ë¬¸ì¥ì€ ê³µê°ìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.)
                   - ëŒ€í™”ì˜ 70%ëŠ” ë¬¸ì œì˜ ì›ì¸ì„ íŒŒì•…í•˜ê³ (Cognitive Analysis), êµ¬ì²´ì ì¸ í–‰ë™ ê³„íš(Action Plan)ì„ ì„¸ìš°ëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”.
                   - 'í•´ê²°ì¤‘ì‹¬ë‹¨ê¸°ì¹˜ë£Œ(SFBT)' ê¸°ë²•ì„ í™œìš©í•˜ì„¸ìš”. (ì˜ˆ: "ê¸°ì  ì§ˆë¬¸", "ì²™ë„ ì§ˆë¬¸", "ëŒ€ì²˜ ì§ˆë¬¸" ë“±)
                   - ë‹µë³€ì˜ ëì—ëŠ” ë‚´ë‹´ìê°€ ë‹¹ì¥ ì‹œë„í•´ ë³¼ ìˆ˜ ìˆëŠ” ì‘ê³  êµ¬ì²´ì ì¸ ë¯¸ì…˜ì„ 1~2ê°€ì§€ë§Œ ì œì•ˆí•˜ì„¸ìš”.
                3. ì£¼ì˜ ì‚¬í•­: ê³µê°ì„ ìƒëµí•˜ê³  ë°”ë¡œ í•´ê²°ì±…ìœ¼ë¡œ ë„˜ì–´ê°€ì§€ ë§ˆì„¸ìš”. "ë§ì´ í˜ë“œì…¨ê² ë„¤ìš”. ê·¸ë ‡ë‹¤ë©´ ìš°ë¦¬ê°€ ì´ ìƒí™©ì„ ë°”ê¾¸ê¸° ìœ„í•´ ë¬´ì—‡ë¶€í„° í•´ë³¼ ìˆ˜ ìˆì„ê¹Œìš”?"ì™€ ê°™ì€ ì—°ê²° ê³ ë¦¬ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
                `;
            }

            // [3] Robustness & Format (ì…ë ¥ ë°©ì–´ ë° í˜•ì‹)
            const robustnessPrompt = `
                [ì…ë ¥ ì–¸ì–´ ì²˜ë¦¬ ë° ëŒ€í™” ìŠ¤íƒ€ì¼ ë°©ì–´ ê°€ì´ë“œ]
                1. ë‚´ë‹´ìê°€ ë¹„ì†ì–´, ì€ì–´, ì¤„ì„ë§, ì‚¬íˆ¬ë¦¬, í˜¹ì€ ë¬¸ë²•ì— ë§ì§€ ì•ŠëŠ” ë¬¸ì¥ì„ ì‚¬ìš©í•˜ë”ë¼ë„, 'Dr. Mind'ëŠ” ì ˆëŒ€ ë™ìš”í•˜ì§€ ë§ê³  **í‘œì¤€ì–´ì™€ ì •ì¤‘í•œ íƒœë„**ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
                2. ë‚´ë‹´ìì˜ ë§ì´ ê³µê²©ì ì´ê±°ë‚˜ ë‘ì„œê°€ ì—†ë”ë¼ë„, ê·¸ ì´ë©´ì— ìˆëŠ” 'ë‹µë‹µí•¨'ê³¼ 'SOS ì‹ í˜¸'ë¥¼ ì½ì–´ë‚´ì–´ ì¹¨ì°©í•˜ê²Œ ëŒ€ì‘í•˜ì„¸ìš”.
                3. ë‹µë³€ í˜•ì‹:
                   - ëª¨ë°”ì¼ í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬, ë‹µë³€ì€ **ìµœëŒ€ 3~4ë¬¸ì¥**ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ëŠì–´ì„œ ì‘ì„±í•˜ì„¸ìš”. (ì¥í™©í•œ ì„¤êµ ê¸ˆì§€)
                   - ê°€ë…ì„±ì„ ìœ„í•´ ì ì ˆíˆ ì¤„ë°”ê¿ˆì„ ì‚¬ìš©í•˜ì„¸ìš”.
            `;

            // Combine all
            const fullSystemInstruction = basePrompt + "\n\n" + modeInstruction + "\n\n" + robustnessPrompt;
            
            const welcomeMsg = mode === 'empathy' 
                ? 'ì•ˆë…•í•˜ì„¸ìš”. ë§ì´ ì§€ì¹˜ì…¨ì£ ? ì˜¤ëŠ˜ í•˜ë£¨, ë§ˆìŒì— ë‹´ì•„ë‘ì—ˆë˜ í˜ë“  ì´ì•¼ê¸°ë¥¼ ì²œì²œíˆ ë“¤ë ¤ì£¼ì„¸ìš”. ì œê°€ ê³ì—ì„œ ë“£ê² ìŠµë‹ˆë‹¤.' 
                : 'ì•ˆë…•í•˜ì„¸ìš”. ê²ªê³  ê³„ì‹  ë¬¸ì œë¥¼ í•¨ê»˜ í’€ì–´ê°€ ë³´ê³  ì‹¶ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒí™©ì„ ë§ì”€í•´ ì£¼ì‹œë©´, êµ¬ì²´ì ì¸ í•´ê²° ë°©ë²•ì„ ì°¾ì•„ë“œë¦¬ê² ìŠµë‹ˆë‹¤.';
            
            window.chat.addMsg('ai', welcomeMsg);

            if (API_KEY) {
                try {
                    genAI = new GoogleGenerativeAI(API_KEY);
                    const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview", systemInstruction: fullSystemInstruction });
                    chatSession = model.startChat({ history: [] });
                    isAIReady = true;
                } catch (e) { console.error(e); }
            }
        },

        goChat: (targetMode) => {
            if (targetMode === 'human') {
                if(tickets > 0) {
                    tickets--;
                    window.app.switchTab('chat'); 
                    alert(`ìƒë‹´ê¶Œì´ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤. (ì”ì—¬: ${tickets}íšŒ)`);
                    window.chat.mode = 'human'; 
                    document.getElementById('chat-mode-selector').style.display = 'none';
                    window.chat.addMsg('system', 'ğŸ”’ ì „ë¬¸ê°€ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. (ìµëª… ë³´ì¥)');
                } else {
                    if(confirm("ì”ì—¬ ìƒë‹´ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ìƒë‹´ê¶Œì„ ì¶©ì „í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        document.getElementById('payment-modal').style.display='flex';
                    }
                    return;
                }
            } else {
                window.chat.mode = 'ai';
                window.app.switchTab('chat');
            }
        },

        connectExpertDirect: () => {
            document.getElementById('emergency-popup').classList.remove('show');
            window.chat.goChat('human');
        },

        send: async () => {
            const input = document.getElementById('input-msg');
            const txt = input.value.trim();
            if(!txt) return;
            
            const dangerWords = ['ì£½ê³ ì‹¶', 'ìì‚´', 'ë›°ì–´ë‚´', 'ì‚´ê¸°ì‹«', 'ìí•´', 'ì£½ì„ë˜'];
            if (dangerWords.some(word => txt.includes(word))) {
                document.getElementById('emergency-popup').classList.add('show');
                window.chat.addMsg('user', txt);
                window.chat.addMsg('ai', 'âš ï¸ ìœ„í—˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì–´ ê¸´ê¸‰ ë³´í˜¸ ëª¨ë“œê°€ ì‘ë™í–ˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì™€ ì—°ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                input.value = '';
                window.chat.saveLog();
                return;
            }

            window.chat.addMsg('user', txt);
            input.value = '';

            if (window.chat.mode === 'human') {
                setTimeout(() => {
                    window.chat.addMsg('expert', 'ë„¤, ë°ì´í„° í™•ì¸í–ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ ìƒí™©ì„ ì¡°ê¸ˆ ë” ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?');
                    window.chat.saveLog();
                }, 1000);
                return;
            }
            
            if (!isAIReady) return;
            try {
                const result = await chatSession.sendMessage(txt);
                window.chat.addMsg('ai', result.response.text());
                window.chat.saveLog();
            } catch (error) { 
                window.chat.addMsg('system', 'ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); 
            }
        },

        addMsg: (type, text) => {
            const container = document.getElementById('msg-container');
            const div = document.createElement('div');
            if (type === 'expert') {
                div.className = `msg expert`; 
                div.innerHTML = `<span style="display:block; font-size:10px; font-weight:bold; margin-bottom:4px; color:#0C8599;">ìƒë‹´ì‚¬ Kim</span>${text}`;
            } else {
                div.className = `msg ${type}`; 
                div.innerHTML = text;
            }
            container.appendChild(div); 
            container.scrollTop = container.scrollHeight;
            window.chat.currentMessages.push({type, text, time: new Date().toLocaleTimeString()});
        },

        saveLog: () => {
            const today = new Date().toISOString().split('T')[0];
            const existingLogIndex = chatHistory.findIndex(log => log.date === today);
            
            if (existingLogIndex >= 0) {
                chatHistory[existingLogIndex].messages = window.chat.currentMessages;
                chatHistory[existingLogIndex].preview = window.chat.currentMessages[window.chat.currentMessages.length-1].text.substring(0, 20) + "...";
            } else {
                chatHistory.push({
                    date: today,
                    messages: window.chat.currentMessages,
                    preview: window.chat.currentMessages[0].text.substring(0, 20) + "..."
                });
            }
            localStorage.setItem('mindChatHistory', JSON.stringify(chatHistory));
        },
        
        toggleSidebar: () => {
            const sidebar = document.getElementById('chat-sidebar');
            const list = document.getElementById('history-list');
            sidebar.classList.toggle('open');
            
            if (sidebar.classList.contains('open')) {
                list.innerHTML = '';
                const sortedHistory = [...chatHistory].reverse();
                if (sortedHistory.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì €ì¥ëœ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                sortedHistory.forEach(log => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `<div class="history-date">${log.date}</div>${log.preview}`;
                    item.onclick = () => alert(`[${log.date}] ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.\n(ì‹¤ì œ ê¸°ëŠ¥: ëŒ€í™”ì°½ ë‚´ìš©ì„ ì´ ê¸°ë¡ìœ¼ë¡œ êµì²´)`);
                    list.appendChild(item);
                });
            }
        },

        clearHistory: () => {
            if(confirm('ì •ë§ ëª¨ë“  ìƒë‹´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ë¸Œë¼ìš°ì €ì—ì„œ ì˜êµ¬ ì‚­ì œë©ë‹ˆë‹¤.')) {
                chatHistory = [];
                window.chat.currentMessages = [];
                localStorage.removeItem('mindChatHistory');
                document.getElementById('msg-container').innerHTML = '';
                document.getElementById('history-list').innerHTML = '<div style="padding:20px; text-align:center; color:#999;">ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                alert('ëª¨ë“  ê¸°ë¡ì´ ì•ˆì „í•˜ê²Œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }
    };

    // 3. Booking Manager
    window.booking = {
        open: () => { document.getElementById('booking-view').classList.add('active'); },
        close: () => { document.getElementById('booking-view').classList.remove('active'); },
        selectTime: (btn) => {
            const parent = btn.parentElement;
            parent.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        },
        confirm: () => {
            const selected = document.querySelector('.time-btn.selected');
            if(!selected) { alert('ì˜ˆì•½í•˜ì‹¤ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if(confirm(`${selected.innerText}ë¡œ ì˜ˆì•½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                alert('ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì•Œë¦¼í†¡ì´ ë°œì†¡ë©ë‹ˆë‹¤)');
                window.booking.close();
            }
        }
    };

    // 4. Admin & Sensor & Init
    window.admin = {
        chart: null,
        initChart: () => {
            if(window.admin.chart) return;
            const ctx = document.getElementById('adminChart').getContext('2d');
            window.admin.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë§ˆì¼€íŒ…', 'ê°œë°œ', 'ì˜ì—…', 'ì¸ì‚¬', 'ë””ìì¸'],
                    datasets: [{
                        label: 'í‰ê·  ìŠ¤íŠ¸ë ˆìŠ¤',
                        data: [82, 55, 78, 40, 65],
                        backgroundColor: ['#FF6B6B', '#00D2BA', '#FF9F43', '#54A0FF', '#5f27cd']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    };

    const sensor = {
        chart: null, 
        data: Array(30).fill(70), 
        val: 70,
        
        init: () => {
            const ctx = document.getElementById('liveChart').getContext('2d');
            sensor.chart = new Chart(ctx, { 
                type: 'line', 
                data: { 
                    labels: Array(30).fill(''), 
                    datasets: [{ 
                        data: sensor.data, 
                        borderColor: '#0066FF', 
                        borderWidth: 2, 
                        pointRadius: 0, 
                        tension: 0.4, 
                        fill: true, 
                        backgroundColor: 'rgba(0,102,255,0.1)' 
                    }] 
                }, 
                options: { 
                    responsive: true, maintainAspectRatio: false, animation: false, 
                    scales: { x: {display:false}, y: {min:40, max:130, display:false} }, 
                    plugins: { legend: {display:false} } 
                } 
            });
            
            const wCtx = document.getElementById('weekChart').getContext('2d');
            new Chart(wCtx, {
                type: 'line',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{ 
                        data: [65, 72, 68, 85, 92, 78, 70], 
                        borderColor: '#FF6B6B', 
                        backgroundColor: 'rgba(255,107,107,0.1)', 
                        tension: 0.4, fill: true 
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
            
            const cCtx = document.getElementById('causeChart').getContext('2d');
            new Chart(cCtx, {
                type: 'bar',
                data: {
                    labels: ['ì—…ë¬´ ê³¼ë¶€í•˜', 'ëŒ€ì¸ê´€ê³„', 'ìˆ˜ë©´ ë¶€ì¡±', 'ë¯¸ë˜ ë¶ˆì•ˆ'],
                    datasets: [{
                        label: 'ìŠ¤íŠ¸ë ˆìŠ¤ ê¸°ì—¬ë„',
                        data: [85, 45, 90, 60],
                        backgroundColor: ['#FF6B6B', '#54A0FF', '#636E72', '#a29bfe'],
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true, max: 100 } }
                }
            });

            setInterval(sensor.update, 800);
        },
        
        update: () => {
            if (!window.app.isWatchConnected) return;

            const change = (Math.random() * 6) - 3; 
            sensor.val = Math.max(60, Math.min(120, sensor.val + change));
            if(Math.random() < 0.02) sensor.val = 115; 
            
            const bpm = Math.floor(sensor.val); 
            sensor.data.push(bpm); 
            sensor.data.shift(); 
            sensor.chart.update();
            
            document.getElementById('bpm-val').innerText = bpm + " bpm";
            
            if (bpm > 110 && !window.app.alertDismissed) {
                document.getElementById('panic-alert').classList.add('show');
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.onclick = () => window.app.switchTab(btn.dataset.tab));
        document.getElementById('send-btn').onclick = () => window.chat.send();
        document.getElementById('input-msg').onkeypress = (e) => { if (e.key === 'Enter') window.chat.send(); };
        document.getElementById('privacy-btn').onclick = window.app.showPrivacy;
        document.getElementById('dismiss-alert-btn').onclick = window.app.dismissAlert;
        document.getElementById('connect-human-btn').onclick = () => window.chat.goChat('human');
        document.getElementById('sos-btn').onclick = () => window.chat.goChat('human');
        document.getElementById('btn-book-expert').onclick = window.booking.open;
        
        sensor.init();
    });
</script>
</body>
</html>
