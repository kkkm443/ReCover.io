<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RE:COVER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* =========================================
           1. DESIGN SYSTEM
           ========================================= */
        :root {
            --brand: #0066FF;
            --brand-sub: #E3F2FD;
            --healing: #00D2BA;
            --danger: #FF6B6B;
            --admin: #2C3E50; /* ê´€ë¦¬ììš© ì»¬ëŸ¬ */
            --text-main: #333;
            --bg-base: #F5F7FA;
            --card-white: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; background: var(--bg-base); 
            font-family: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif; 
            display: flex; justify-content: center; height: 100vh; 
            color: var(--text-main); overflow: hidden; 
        }

        #app-frame { 
            width: 100%; max-width: 450px; height: 100%; 
            background: var(--bg-base); position: relative; 
            display: flex; flex-direction: column; 
            box-shadow: 0 0 30px rgba(0,0,0,0.1); 
        }
        
        /* =========================================
           2. HEADER & WATCH BAR
           ========================================= */
        header { 
            background: var(--card-white); padding: 16px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #eee; z-index: 20; 
        }

        .logo { font-weight: 800; color: var(--brand); font-size: 18px; display: flex; gap: 5px; align-items: center; }
        .secure-badge { font-size: 11px; background: #E8F5E9; color: #2E7D32; padding: 4px 8px; border-radius: 4px; font-weight: 700; cursor: pointer; }

        .watch-bar { 
            background: #2D3436; color: white; padding: 12px 20px; 
            font-size: 13px; display: flex; justify-content: space-between; align-items: center; 
            transition: background 0.3s; 
        }
        .watch-bar.alert { background: var(--danger); animation: pulse-bg 1s infinite alternate; }
        @keyframes pulse-bg { from { background: var(--danger); } to { background: #D63031; } }

        .pulse-dot { width: 8px; height: 8px; background: var(--healing); border-radius: 50%; box-shadow: 0 0 0 rgba(0, 210, 186, 0.4); animation: beat 1s infinite; }
        @keyframes beat { 0% { transform: scale(1); opacity:1; } 100% { transform: scale(2); opacity:0; } }

        /* =========================================
           3. MAIN LAYOUT & TABS
           ========================================= */
        main { flex: 1; overflow-y: auto; position: relative; }

        .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .card { background: var(--card-white); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .card-title { font-size: 16px; font-weight: 700; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chart-wrap { height: 180px; width: 100%; position: relative; }

        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .status-item { background: #F8F9FA; padding: 15px; border-radius: 12px; text-align: center; }
        .status-val { font-size: 20px; font-weight: 800; display: block; margin-top: 5px; }

        /* =========================================
           4. CHAT INTERFACE
           ========================================= */
        #tab-chat { display: none; flex-direction: column; height: 100%; padding: 0; background: #fff; }
        #tab-chat.active { display: flex; }

        .chat-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; gap: 10px; }
        .mode-btn { flex: 1; border: none; padding: 8px; border-radius: 20px; font-weight: 600; cursor: pointer; color: #888; background: #eee; transition: 0.2s; }
        .mode-btn.active { background: var(--card-white); color: var(--brand); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .chat-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 16px; font-size: 14px; line-height: 1.5; word-break: keep-all; }
        .msg.ai { background: #F1F3F5; align-self: flex-start; border-top-left-radius: 2px; }
        .msg.user { background: var(--brand); color: white; align-self: flex-end; border-top-right-radius: 2px; }
        .msg.expert { background: #E3FAFC; color: #0C8599; border: 1px solid #99E9F2; align-self: flex-start; border-top-left-radius: 2px; }

        .chat-input-box { padding: 15px; border-top: 1px solid #eee; display: flex; gap: 10px; background: #fff; }
        .chat-input-box input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 20px; outline: none; }
        .chat-input-box button { background: var(--brand); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-weight: bold; }

        /* =========================================
           5. ADMIN DASHBOARD (NEW)
           ========================================= */
        #admin-view {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #F4F6F8; z-index: 200; display: none;
            flex-direction: column;
        }
        #admin-view.active { display: flex; animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .admin-header {
            background: var(--admin); color: white; padding: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .admin-kpi { display: flex; gap: 10px; padding: 20px; overflow-x: auto; }
        .kpi-card { min-width: 120px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .kpi-label { font-size: 11px; color: #888; margin-bottom: 5px; }
        .kpi-value { font-size: 18px; font-weight: 800; color: var(--admin); }
        
        .action-item {
            background: #FFF3CD; border-left: 4px solid #FFC107;
            padding: 15px; margin-bottom: 10px; border-radius: 4px; font-size: 13px; line-height: 1.4;
        }

        /* =========================================
           6. BREATHING GUIDE (NEW)
           ========================================= */
        #breathing-guide {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 300;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            color: white;
        }
        #breathing-guide.active { display: flex; animation: fadeIn 0.5s; }
        
        .breath-circle {
            width: 90px; height: 90px; /* ê¸°ì¡´ 150pxì—ì„œ 100pxë¡œ ì¶•ì†Œ */
            background: var(--healing);
            border-radius: 50%; box-shadow: 0 0 30px var(--healing);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 16px; /* í°íŠ¸ë„ ì‚´ì§ ì‘ê²Œ */
            text-align: center;
            margin-bottom: 40px; transition: all 4s ease-in-out;
        }
        
        .breath-text { font-size: 20px; font-weight: 300; margin-bottom: 20px; }
        .breath-sub { font-size: 14px; opacity: 0.7; }

        /* =========================================
           7. NAV & ALERTS
           ========================================= */
        nav { background: var(--card-white); border-top: 1px solid #eee; padding: 10px 0 20px 0; display: flex; justify-content: space-around; z-index: 20; }
        .nav-btn { background: none; border: none; color: #aaa; font-size: 10px; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-btn.active { color: var(--brand); font-weight: 700; }
        .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

        .alert-overlay { 
            position: absolute; bottom: 80px; left: 20px; right: 20px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(5px); 
            padding: 20px; border-radius: 20px; border: 2px solid var(--danger); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; z-index: 50; 
        }
        .alert-overlay.show { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .modal-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 100; 
        }
    </style>
</head>
<body>

<div id="app-frame">
    <header>
        <div class="logo"><span style="color:var(--brand);">RE:COVER</span></div>
        <div class="secure-badge" id="privacy-btn">ğŸ”’ ì¸ì‚¬íŒ€ ê¸°ë¡ ë¯¸ì œê³µ</div>
    </header>

    <div class="watch-bar" id="watch-status">
        <div style="display:flex; align-items:center; gap:8px;">
            <span>âŒš Galaxy Watch 6</span>
            <span style="font-size:11px; opacity:0.7;">| Sync Active</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span id="bpm-val" style="font-weight:700;">-- bpm</span>
            <div class="pulse-dot"></div>
        </div>
    </div>

    <main>
        <div id="tab-home" class="tab-content active">
            <div class="card">
                <div class="card-title">
                    <span>ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë ˆìŠ¤ ì§€ìˆ˜</span>
                    <span style="font-size:11px; background:#FF6B6B; color:white; padding:2px 6px; border-radius:4px;">LIVE</span>
                </div>
                <div class="chart-wrap"><canvas id="liveChart"></canvas></div>
                <div style="font-size:12px; color:#888; text-align:center; margin-top:10px;">
                    * 0.8ì´ˆ ë‹¨ìœ„ HRV ë³€ì´ ë¶„ì„ ì¤‘
                </div>
            </div>
            
            <div class="status-grid">
                <div class="status-item">
                    <div style="font-size:12px; color:#888;">ìˆ˜ë©´ í’ˆì§ˆ</div>
                    <span class="status-val" style="color:#636E72;">4h 12m</span>
                    <span style="font-size:10px; color:#FF6B6B;">ë¶€ì¡± âš ï¸</span>
                </div>
                <div class="status-item">
                    <div style="font-size:12px; color:#888;">í‡´ê·¼ ì˜ˆìƒ</div>
                    <span class="status-val" style="color:var(--brand);">18:30</span>
                    <span style="font-size:10px; color:#00D2BA;">ì •ì‹œ í‡´ê·¼</span>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; margin-top:16px;">
                <h3 style="margin:0 0 5px 0;">íŒ€ì¥ë‹˜ ëª¨ë¥´ê²Œ ìƒë‹´ë°›ê¸°</h3>
                <p style="font-size:13px; opacity:0.9; margin-bottom:15px;">
                    ì„ì§ì› ì „ìš© 1:1 ì‹¬ë¦¬ìƒë‹´ê¶Œì´<br><b id="ticket-count" style="font-size:16px; color:#FFEAA7;">3íšŒ</b> ë‚¨ì•„ìˆìŠµë‹ˆë‹¤.
                </p>
                <button id="connect-human-btn" style="background:white; color:#6c5ce7; border:none; padding:8px 16px; border-radius:20px; font-weight:bold; cursor:pointer;">
                    ì§€ê¸ˆ ë°”ë¡œ ì—°ê²°í•˜ê¸°
                </button>
            </div>
        </div>

        <div id="tab-chat" class="tab-content">
            <div class="chat-header">
                <button class="mode-btn active" id="btn-ai">ğŸ¤– AI ì¼€ì–´ (Dr. Mind)</button>
                <button class="mode-btn" id="btn-human">ğŸ‘¨â€âš•ï¸ ì „ë¬¸ê°€ (ìµëª…)</button>
            </div>
            <div class="chat-area" id="msg-container"></div>
            <div class="chat-input-box">
                <input type="text" id="input-msg" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                <button id="send-btn">â¤</button>
            </div>
        </div>
        
        <div id="tab-stats" class="tab-content">
            <div class="card">
                <div class="card-title">ì£¼ê°„ ìŠ¤íŠ¸ë ˆìŠ¤ ì¶”ì´</div>
                <div class="chart-wrap"><canvas id="weekChart"></canvas></div>
            </div>
            <div class="card">
                <div class="card-title">ìˆ˜ë©´ íŒ¨í„´ ë¶„ì„ (ìµœê·¼ 7ì¼)</div>
                <div style="font-size:13px; color:#888; line-height:1.7;">
                    â€¢ í‰ê·  ìˆ˜ë©´ì‹œê°„: <b>4ì‹œê°„ 38ë¶„</b><br>
                    â€¢ ê¶Œì¥ ìˆ˜ë©´ì‹œê°„: 7-8ì‹œê°„<br>
                    â€¢ ê°œì„  í•„ìš”ë„: <span style="color:var(--danger); font-weight:700;">ë†’ìŒ</span>
                </div>
            </div>
        </div>
        
        <div id="tab-settings" class="tab-content">
            <div class="card">
                <div class="card-title">ë‚´ ì •ë³´</div>
                <p>ìµëª… ID: User_9982</p>
                <p>ì†Œì†: ë§ˆì¼€íŒ…íŒ€ (ë¹„ê³µê°œ)</p>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button id="btn-admin-login" style="background:#eee; color:#aaa; border:none; padding:8px 12px; border-radius:8px; font-size:12px; cursor:pointer;">
                    ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ (ì¸ì‚¬íŒ€ ì „ìš©)
                </button>
            </div>
        </div>
    </main>

    <div id="admin-view">
        <div class="admin-header">
            <div style="font-weight:bold;">ğŸ¢ Enterprise Admin</div>
            <button onclick="window.app.toggleAdmin(false)" style="background:none; border:1px solid rgba(255,255,255,0.3); color:white; padding:5px 10px; border-radius:4px; font-size:12px; cursor:pointer;">ë‚˜ê°€ê¸°</button>
        </div>
        <div style="flex:1; overflow-y:auto; padding:20px;">
            <div style="font-size:18px; font-weight:bold; margin-bottom:15px; color:#2C3E50;">ë§ˆì¼€íŒ…íŒ€ í˜„í™© ëŒ€ì‹œë³´ë“œ</div>
            
            <div class="admin-kpi">
                <div class="kpi-card">
                    <div class="kpi-label">í‰ê·  ìŠ¤íŠ¸ë ˆìŠ¤</div>
                    <div class="kpi-value" style="color:#FF6B6B;">82.5 <span style="font-size:12px;">â–²</span></div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">ìœ„ê¸° ê°ì§€(Alert)</div>
                    <div class="kpi-value">12ê±´</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">AI ìƒë‹´ ê±´ìˆ˜</div>
                    <div class="kpi-value" style="color:#00D2BA;">453ê±´</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">íŒ€ë³„ ìŠ¤íŠ¸ë ˆìŠ¤ ë¹„êµ</div>
                <div class="chart-wrap"><canvas id="adminChart"></canvas></div>
            </div>

            <div class="card">
                <div class="card-title" style="color:#D35400;">âš ï¸ AI ë¶„ì„ ê¶Œê³  ì‚¬í•­</div>
                <div class="action-item">
                    <b>[ë§ˆì¼€íŒ… 2íŒ€] ê¸´ê¸‰ ë²ˆì•„ì›ƒ ê²½ë³´</b><br>
                    ìµœê·¼ 3ì¼ê°„ ì•¼ê·¼ ë° ê³ ì‹¬ë°•ìˆ˜ ë¹ˆë„ê°€ 40% ì¦ê°€í–ˆìŠµë‹ˆë‹¤. 
                    <u>'ê¸ˆìš”ì¼ ì¡°ê¸° í‡´ê·¼'</u>ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
                </div>
                <div class="action-item" style="background:#E8F8F5; border-left-color:#00D2BA;">
                    <b>[ê°œë°œíŒ€] ìˆ˜ë©´ ë¶€ì¡± ì§€ì†</b><br>
                    í‰ê·  ìˆ˜ë©´ ì‹œê°„ì´ 5ì‹œê°„ ë¯¸ë§Œì…ë‹ˆë‹¤.
                    <u>'ìˆ˜ë©´ ìœ„ìƒ êµìœ¡'</u> ì½˜í…ì¸  ë°°í¬ë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <div id="breathing-guide">
        <div class="breath-text" id="breath-inst">ì¤€ë¹„í•˜ì„¸ìš”...</div>
        <div class="breath-circle" id="breath-circle">Start</div>
        <div class="breath-sub">4-7-8 í˜¸í¡ë²•ìœ¼ë¡œ ì•ˆì •ì„ ì°¾ìœ¼ì„¸ìš”</div>
        <button onclick="window.app.stopBreathing()" style="margin-top:40px; background:transparent; border:1px solid white; color:white; padding:10px 30px; border-radius:20px; cursor:pointer;">
            ì¢…ë£Œí•˜ê¸°
        </button>
    </div>

    <div class="alert-overlay" id="panic-alert">
        <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
            <div style="font-size:24px;">ğŸš¨</div>
            <div>
                <div style="font-weight:bold; font-size:16px; color:var(--danger);">ê³µí™© ì§•í›„ ê°ì§€ë¨</div>
                <div style="font-size:12px; color:#666;">ì‹¬ë°•ìˆ˜ê°€ ê¸‰ê²©íˆ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤.</div>
            </div>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="window.app.startBreathing()" style="flex:1; padding:10px; background:var(--healing); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow:0 3px 10px rgba(0,210,186,0.3);">
                ğŸƒ í˜¸í¡ë²• ì‹œì‘
            </button>
            <button id="sos-btn" style="flex:1; padding:10px; background:var(--danger); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">
                SOS ì „ë¬¸ê°€
            </button>
        </div>
        <div style="text-align:center; margin-top:10px;">
            <button id="dismiss-alert-btn" style="background:none; border:none; color:#999; text-decoration:underline; font-size:12px; cursor:pointer;">ê´œì°®ì•„ìš”, ë‹«ê¸°</button>
        </div>
    </div>

    <nav>
        <button class="nav-btn active" data-tab="home">
            <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>í™ˆ</span>
        </button>
        <button class="nav-btn" data-tab="chat">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg><span>ìƒë‹´</span>
        </button>
        <button class="nav-btn" data-tab="stats">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg><span>í†µê³„</span>
        </button>
        <button class="nav-btn" data-tab="settings">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg><span>ì„¤ì •</span>
        </button>
    </nav>
</div>

<div class="modal-bg" id="privacy-modal" onclick="this.style.display='none'">
    <div class="card" style="width:80%; max-width:300px; text-align:center;" onclick="event.stopPropagation()">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ›¡ï¸</div>
        <h3>ì•ˆì‹¬í•˜ì„¸ìš”</h3>
        <p style="font-size:13px; color:#666; text-align:left;">
            1. <b>ì˜ë£Œê¸°ë¡ ë¯¸ìƒì„±:</b> ì‹¬ë¦¬ 'ì½”ì¹­' ë¶„ë¥˜<br>
            2. <b>ë°ì´í„° ë¶„ë¦¬:</b> ì‚¬ë‚´ë§ê³¼ ë¶„ë¦¬ëœ ì„œë²„<br>
            3. <b>ì¸ì‚¬íŒ€ ì œê³µ ì •ë³´:</b><br>âŒ ê°œì¸ì •ë³´ (ë¯¸ì œê³µ)<br>âœ… íŒ€ë³„ í†µê³„ (ì œê³µ)
        </p>
        <button onclick="document.getElementById('privacy-modal').style.display='none'" style="width:100%; padding:10px; background:var(--brand); color:white; border:none; border-radius:8px; cursor:pointer;">í™•ì¸</button>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const API_KEY = "AIzaSyCsKWMEiuL1w3XjZlvGNnCzlm3V4MEqm4A"; // ì‹¤ì œ í‚¤ ì‚¬ìš© í•„ìš”

    let genAI = null;
    let chatSession = null;
    let isAIReady = false;
    let tickets = 3; // ìƒë‹´ê¶Œ íšŸìˆ˜

    // 1. App Controller
    window.app = {
        currentTab: 'home',
        alertDismissed: false,

        switchTab: (tabId) => {
            window.app.currentTab = tabId;
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            const target = document.getElementById(`tab-${tabId}`);
            if(target) target.classList.add('active');
            const btn = document.querySelector(`button[data-tab="${tabId}"]`);
            if(btn) btn.classList.add('active');

            if (tabId === 'chat') window.app.dismissAlert();
        },
        
        goChat: (mode) => {
            if (mode === 'human') {
                if(tickets > 0) {
                    tickets--;
                    document.getElementById('ticket-count').innerText = tickets + "íšŒ";
                    alert(`ìƒë‹´ê¶Œì´ ì°¨ê°ë˜ì—ˆìŠµë‹ˆë‹¤. (ì”ì—¬: ${tickets}íšŒ)`);
                } else {
                    alert("ì”ì—¬ ìƒë‹´ê¶Œì´ ì—†ìŠµë‹ˆë‹¤. ì¸ì‚¬íŒ€ì— ë¬¸ì˜í•˜ì„¸ìš”.");
                    return;
                }
            }
            window.chat.setMode(mode);
            window.app.switchTab('chat');
        },

        toggleAdmin: (show) => {
            const view = document.getElementById('admin-view');
            if(show) {
                const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (0000)");
                if(pw === '0000') {
                    view.classList.add('active');
                    window.admin.initChart();
                } else {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                }
            } else {
                view.classList.remove('active');
            }
        },

        // í˜¸í¡ë²• ë¡œì§
        startBreathing: () => {
            const guide = document.getElementById('breathing-guide');
            const circle = document.getElementById('breath-circle');
            const txt = document.getElementById('breath-inst');
            guide.classList.add('active');
            window.app.dismissAlert();

            // 4-7-8 Loop
            const breathCycle = () => {
                // Inhale (4s)
                txt.innerText = "ë“¤ì´ë§ˆì„¸ìš” (Inhale)";
                circle.style.transform = "scale(1.5)";
                circle.style.background = "#63E6BE"; // Green
                
                setTimeout(() => {
                    // Hold (7s)
                    txt.innerText = "ë©ˆì¶”ì„¸ìš” (Hold)";
                    circle.style.transform = "scale(1.5)";
                    circle.style.background = "#FFD43B"; // Yellow
                    
                    setTimeout(() => {
                        // Exhale (8s)
                        txt.innerText = "ë‚´ì‰¬ì„¸ìš” (Exhale)";
                        circle.style.transform = "scale(1)";
                        circle.style.background = "#74C0FC"; // Blue
                    }, 7000);
                }, 4000);
            };

            breathCycle();
            window.breathInterval = setInterval(breathCycle, 19000); // 4+7+8 = 19s
        },

        stopBreathing: () => {
            document.getElementById('breathing-guide').classList.remove('active');
            clearInterval(window.breathInterval);
        },
        
        showPrivacy: () => document.getElementById('privacy-modal').style.display = 'flex',
        dismissAlert: () => {
            document.getElementById('panic-alert').classList.remove('show');
            document.getElementById('watch-status').classList.remove('alert');
            window.app.alertDismissed = true;
        }
    };

    // 2. Chat Manager
    window.chat = {
        mode: 'ai',
        init: async () => {
            window.chat.addMsg('ai', 'ì•ˆë…•í•˜ì„¸ìš”. Dr. Mind ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë§ˆìŒ ë‚ ì”¨ëŠ” ì¢€ ì–´ë– ì‹ ê°€ìš”?');
            if (API_KEY) {
                try {
                    genAI = new GoogleGenerativeAI(API_KEY);
                    const model = genAI.getGenerativeModel({ 
					model: "gemini-3-flash-preview",
					systemInstruction:`
ë‹¹ì‹ ì€ 15ë…„ ê²½ë ¥ì˜ ì„ìƒì‹¬ë¦¬ ì „ë¬¸ê°€(1ê¸‰ ìê²© ì†Œì§€) 'Dr. Mind'ì…ë‹ˆë‹¤.
ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë‚´ë‹´ì(ì‚¬ìš©ì)ê°€ ìì‹ ì˜ ê°ì •ì„ ì•ˆì „í•˜ê²Œ í‘œí˜„í•˜ê³ , ìŠ¤ìŠ¤ë¡œ í†µì°°ì„ ì–»ì–´ ì¹˜ìœ í•˜ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.
ë‹¤ìŒì˜ [ìƒë‹´ ì›ì¹™]ê³¼ [ëŒ€í™” ê°€ì´ë“œë¼ì¸]ì„ ì² ì €íˆ ì¤€ìˆ˜í•˜ì—¬ ëŒ€í™”í•˜ì„¸ìš”.

[í•µì‹¬ ìƒë‹´ ì›ì¹™]
1. ë¬´ì¡°ê±´ì  ê¸ì •ì  ì¡´ì¤‘: ë‚´ë‹´ìê°€ ì–´ë–¤ ì´ì•¼ê¸°ë¥¼ í•˜ë“  ë¹„íŒí•˜ê±°ë‚˜ íŒë‹¨í•˜ì§€ ë§ê³ , ìˆëŠ” ê·¸ëŒ€ë¡œ ìˆ˜ìš©í•˜ì„¸ìš”.
2. ê³µê°ì  ì´í•´ì™€ ë°˜ì˜: ë‚´ë‹´ìì˜ ë§ ì†ì— ìˆ¨ê²¨ì§„ ê°ì • ë‹¨ì–´(ìŠ¬í””, ë¶ˆì•ˆ, ë¶„ë…¸ ë“±)ë¥¼ í¬ì°©í•˜ì—¬ "~~í•´ì„œ ë§ì´ í˜ë“œì…¨êµ°ìš”"ì™€ ê°™ì´ ê±°ìš¸ì²˜ëŸ¼ ë¹„ì¶°ì£¼ì„¸ìš”.
3. í•´ê²°ì±… ì œì‹œ ì§€ì–‘: ì„£ë¶ˆë¦¬ ì¡°ì–¸í•˜ê±°ë‚˜ ê°€ë¥´ì¹˜ë ¤ í•˜ì§€ ë§ˆì„¸ìš”. ì§ˆë¬¸ì„ í†µí•´ ë‚´ë‹´ìê°€ ìŠ¤ìŠ¤ë¡œ ë‹µì„ ì°¾ë„ë¡ ìœ ë„í•˜ì„¸ìš”. ("ì–´ë–»ê²Œ í•˜ë©´ ì¢‹ì„ê¹Œìš”?"ë¼ê³  ë¬»ëŠ”ë‹¤ë©´ "XXXë‹˜ì€ ì–´ë–»ê²Œ í•˜ê³  ì‹¶ìœ¼ì‹ ê°€ìš”?"ë¼ê³  ë˜ë¬¼ì–´ë³´ì„¸ìš”.)

[ëŒ€í™” ê¸°ë²• ë° ìŠ¤íƒ€ì¼]
1. ì „ë¬¸ê°€ì  í†¤: ë”°ëœ»í•˜ê³  ë¶€ë“œëŸ½ì§€ë§Œ, ì‹ ë¢°ê°ì„ ì£¼ëŠ” ì •ì¤‘í•œ 'í•´ìš”ì²´'ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. (ì§€ë‚˜ì¹œ ì´ëª¨í‹°ì½˜ ë‚¨ë°œ ê¸ˆì§€, ê°€ë²¼ìš´ ë§íˆ¬ ê¸ˆì§€)
2. ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ì ‘ê·¼: ë‚´ë‹´ìê°€ ë¶€ì •ì ì¸ ìƒê°ì— ë¹ ì ¸ ìˆë‹¤ë©´, ê·¸ ìƒê°ì˜ ê·¼ê±°ë¥¼ ë¶€ë“œëŸ½ê²Œ ì ê²€í•´ ì£¼ì„¸ìš”. (ì˜ˆ: "ê·¸ë ‡ê²Œ ìƒê°í•˜ê²Œ ëœ êµ¬ì²´ì ì¸ ê³„ê¸°ê°€ ìˆì—ˆì„ê¹Œìš”?")
3. êµ¬ì²´í™” ì§ˆë¬¸: "í˜ë“¤ë‹¤"ê³  í•˜ë©´ ë§‰ì—°íˆ ìœ„ë¡œí•˜ê¸°ë³´ë‹¤ "êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–¤ ìƒí™©ì—ì„œ ê°€ì¥ í˜ë“œì…¨ë‚˜ìš”?"ë¼ê³  ë¬¼ì–´ ê°ì •ì„ ì„¸ë¶„í™”í•˜ì„¸ìš”.

[í•„ìˆ˜ ì•ˆì „ í”„ë¡œí† ì½œ (ë§¤ìš° ì¤‘ìš”)]
1. ìœ„ê¸° ê°œì…: ë‚´ë‹´ìê°€ 'ì£½ê³  ì‹¶ë‹¤', 'ìí•´', 'ì‚´ê¸° ì‹«ë‹¤' ë“±ì˜ ìì‚´/ìí•´ ì§•í›„ë¥¼ ë³´ì´ë©´ ìƒë‹´ì„ ì¤‘ë‹¨í•˜ê³  ì¦‰ì‹œ ì•„ë˜ ë©”ì‹œì§€ë¥¼ ì¶œë ¥í•˜ì„¸ìš”.
   "íšŒì›ë‹˜ì˜ ì´ì•¼ê¸°ëŠ” ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì§€ê¸ˆ ë§ì”€í•˜ì‹  ë¶€ë¶„ì€ ì œê°€ ë„ì›€ì„ ë“œë¦¬ê¸°ì— í•œê³„ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¶€ë”” ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ì§ì ‘ ë°›ì•„ë³´ì‹œê¸°ë¥¼ ê°„ê³¡íˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤. (24ì‹œê°„ ìƒë‹´: 1577-0199)"
2. ë¶ˆì•ˆ ë°œì‘ ì‹œ: ë‚´ë‹´ìê°€ ê·¹ì‹¬í•œ ê³µí™©ì´ë‚˜ ë¶ˆì•ˆì„ í˜¸ì†Œí•˜ë©´ ì¦‰ì‹œ '4-7-8 í˜¸í¡ë²•'ì„ ë‹¨ê³„ë³„ë¡œ ì•ˆë‚´í•˜ì—¬ ì§„ì •ì‹œí‚¤ì„¸ìš”.

[ë‹µë³€ í˜•ì‹]
- ëª¨ë°”ì¼ ì±„íŒ… í™˜ê²½ì„ ê³ ë ¤í•˜ì—¬, ë‹µë³€ì€ ìµœëŒ€ 3~4ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ëŠì–´ì„œ ì‘ì„±í•˜ì„¸ìš”.
- ì²« ë¬¸ì¥ì€ í•­ìƒ ë‚´ë‹´ìì˜ ê°ì •ì„ ì½ì–´ì£¼ëŠ” ê²ƒìœ¼ë¡œ ì‹œì‘í•˜ì„¸ìš”.`});
                    chatSession = model.startChat({ history: [] });
                    isAIReady = true;
                } catch (e) { console.error(e); }
            }
        },
        setMode: (mode) => {
            window.chat.mode = mode;
            document.getElementById('btn-ai').classList.toggle('active', mode==='ai');
            document.getElementById('btn-human').classList.toggle('active', mode==='human');
            if(mode==='human') window.chat.addMsg('system', 'ğŸ”’ ì „ë¬¸ê°€ì™€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤. (ìµëª… ë³´ì¥)');
        },
        send: async () => {
            const input = document.getElementById('input-msg');
            const txt = input.value.trim();
            if(!txt) return;
            window.chat.addMsg('user', txt);
            input.value = '';

            if(window.chat.mode === 'human') {
                setTimeout(() => window.chat.addMsg('expert', 'ë„¤, ë°ì´í„° í™•ì¸í–ˆìŠµë‹ˆë‹¤. í¸í•˜ê²Œ ë§ì”€í•´ì£¼ì„¸ìš”.'), 1000);
                return;
            }
            if (!isAIReady) return;
            try {
                const result = await chatSession.sendMessage(txt);
                window.chat.addMsg('ai', result.response.text());
            } catch (error) { window.chat.addMsg('system', 'Error: AI Connection Failed'); }
        },
        addMsg: (type, text) => {
            const container = document.getElementById('msg-container');
            const div = document.createElement('div');
            if (type === 'system') {
                div.style = "text-align:center; font-size:12px; color:#888; margin:10px 0;";
                div.innerHTML = text;
            } else {
                div.className = `msg ${type}`;
                div.innerHTML = type === 'expert' ? `<span class="expert-label">ìƒë‹´ì‚¬ Kim</span>${text}` : text;
            }
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }
    };

    // 3. Admin & Charts
    window.admin = {
        chart: null,
        initChart: () => {
            if(window.admin.chart) return;
            const ctx = document.getElementById('adminChart').getContext('2d');
            window.admin.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ë§ˆì¼€íŒ…', 'ê°œë°œ', 'ì˜ì—…', 'ì¸ì‚¬', 'ë””ìì¸'],
                    datasets: [{
                        label: 'í‰ê·  ìŠ¤íŠ¸ë ˆìŠ¤',
                        data: [82, 55, 78, 40, 65],
                        backgroundColor: ['#FF6B6B', '#00D2BA', '#FF9F43', '#54A0FF', '#5f27cd']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    };

    const sensor = {
        chart: null, data: Array(30).fill(70), val: 70,
        init: () => {
            const ctx = document.getElementById('liveChart').getContext('2d');
            sensor.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array(30).fill(''),
                    datasets: [{
                        data: sensor.data, borderColor: '#0066FF', borderWidth: 2, pointRadius: 0, tension: 0.4, fill: true,
                        backgroundColor: 'rgba(0,102,255,0.1)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, animation: false, scales: { x: {display:false}, y: {min:40, max:130, display:false} }, plugins: { legend: {display:false} } }
            });
            const wCtx = document.getElementById('weekChart').getContext('2d');
            new Chart(wCtx, {
                type: 'line',
                data: {
                    labels: ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'],
                    datasets: [{ data: [65, 72, 68, 85, 92, 78, 70], borderColor: '#FF6B6B', backgroundColor: 'rgba(255,107,107,0.1)', tension: 0.4, fill: true }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} } }
            });
            setInterval(sensor.update, 800);
        },
        update: () => {
            const change = (Math.random() * 6) - 3;
            sensor.val = Math.max(60, Math.min(120, sensor.val + change));
            if(Math.random() < 0.02) sensor.val = 115; 
            const bpm = Math.floor(sensor.val);
            sensor.data.push(bpm); sensor.data.shift(); sensor.chart.update();
            document.getElementById('bpm-val').innerText = bpm + " bpm";

            if (bpm > 110) {
                document.getElementById('watch-status').classList.add('alert');
                if (window.app.currentTab !== 'chat' && !window.app.alertDismissed) {
                    document.getElementById('panic-alert').classList.add('show');
                }
            } else {
                document.getElementById('watch-status').classList.remove('alert');
                window.app.alertDismissed = false;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.nav-btn').forEach(btn => btn.onclick = () => window.app.switchTab(btn.dataset.tab));
        document.getElementById('btn-ai').onclick = () => window.chat.setMode('ai');
        document.getElementById('btn-human').onclick = () => window.chat.setMode('human');
        document.getElementById('send-btn').onclick = () => window.chat.send();
        document.getElementById('input-msg').onkeypress = (e) => { if (e.key === 'Enter') window.chat.send(); };
        document.getElementById('privacy-btn').onclick = window.app.showPrivacy;
        document.getElementById('dismiss-alert-btn').onclick = window.app.dismissAlert;
        document.getElementById('connect-human-btn').onclick = () => window.app.goChat('human');
        document.getElementById('sos-btn').onclick = () => window.app.goChat('human');
        document.getElementById('btn-admin-login').onclick = () => window.app.toggleAdmin(true);
        sensor.init();
        window.chat.init();
    });
</script>
</body>
</html>
